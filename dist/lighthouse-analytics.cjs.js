"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("event-emitter-object"),e=require("local-storage-pro"),i=require("visibility-state-listener"),r=require("basekits");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=n(t),a=n(e),o=n(i);function c(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s.default.call(this,{}),this.window=t.window||("undefined"==typeof window?void 0:window),this.document=t.document||("undefined"==typeof document?void 0:document),this.memory={events:[],referrer:null},this.isBusy=!1,this.storageKeys={id:"LA_ID",userTimestamp:"LA_USER_TIMESTAMP",sessionTimestamp:"LA_SESSION_TIMESTAMP"},this.sessionLifetime=1800,this.identify(),this.context={id:null,firstVisit:!1},this.visibilityState="visible",r.validationkit.isNotEmpty(t.listenVisibilityChanges)&&this.listenVisibilityChanges(),this.timer=null,r.validationkit.isNotEmpty(t.checkOnlineTime)&&this.startTimer(),this.queue=[],this.services=[]}function p(){this.timeout=1e4}c.prototype=Object.create(s.default.prototype),c.prototype.constructor=c,c.prototype.identify=function(){var t=a.default.getItem(this.storageKeys.id);if(t)this.updateContext({id:t});else{var e=((t=21)=>{let e="",i=t;for(;i--;)e+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[64*Math.random()|0];return e})();this.updateContext({id:e}),a.default.setItem(this.storageKeys.id,e)}var i=this.getTimestamp(),n=a.default.getItem(this.storageKeys.userTimestamp);r.validationkit.isEmpty(n)&&(a.default.setItem(this.storageKeys.userTimestamp,i),this.updateContext({firstVisit:!0}));var s=a.default.getItem(this.storageKeys.sessionTimestamp);(r.validationkit.isEmpty(s)||this.getTimeDiff(i,s)>this.sessionLifetime)&&a.default.setItem(this.storageKeys.sessionTimestamp,i),r.validationkit.isNotEmpty(this.document)&&(this.memory.referrer=this.document.referrer)},c.prototype.listenVisibilityChanges=function(){var t=this,e=o.default({window:this.window,document:this.document});e.start(),e.emitter.on("update",(function(){var i=e.getState();i!=t.visibilityState&&(t.visibilityState=i,t.event("visibilityChange",{value:t.visibilityState}),t.emit("visibilityChange",t.visibilityState))}))},c.prototype.getVisibilityState=function(){return this.visibilityState},c.prototype.setContext=function(t){return r.typekit.isObject(t)&&(this.context=t),this},c.prototype.updateContext=function(t){return r.typekit.isObject(t)&&(this.context=Object.assign({},this.context,t)),this},c.prototype.install=function(){var t=this;return Promise.all(this.services.map((function(e){return e.install?e.install(t):Promise.resolve()})))},c.prototype.addService=function(t){return this.services.push(t),this},c.prototype.startTimer=function(){this.timer=setInterval(function(){this.emit("online"),this.event("online",{})}.bind(this),15e3)},c.prototype.clearTimer=function(){return r.validationkit.isNotEmpty(this.timer)&&(clearInterval(this.timer),this.timer=null),this},c.prototype.isFirstVisit=function(){return this.context.firstVisit},c.prototype.event=function(t,e){return this.addToQueue({name:t,params:e}),this},c.prototype.addToQueue=function(t){return this.queue.push(t),this.processQueue(),!0},c.prototype.processQueue=function(){if(!0!==this.isBusy){this.isBusy=!0;var t=this.queue.shift();return this.processEvent(t.name,t.params),this.isBusy=!1,this.queue.length>0&&this.processQueue(),!0}},c.prototype.processEvent=function(t,e){var i=r.typekit.isString(t)&&r.typekit.isNotEmpty(t)?t:void 0,n=r.typekit.isObject(e)?Object.assign({},this.context,e):void 0;if(i){var s=this.getTimestamp(),a=r.objectkit.getProp(this.getLastEvent(),"_timestamp",s),o=this.getTimeDiff(s,a),c=r.objectkit.getProp(this.getEvent(i),"_timestamp",s),p=this.getTimeDiff(s,c),u={name:i,params:n,_timestamp:s,_timeDiffFromLastEvent:o,_timeDiffFromSameEvent:p};this.memory.events.push(u),0!==this.services.length?Promise.all(this.services.map(function(t){return t.event(i,n)}.bind(this))):this.emit("error",["NO_SERVICE_INSTALLED",new Error("NO_SERVICE_INSTALLED")])}else this.emit("error",["INVALID_EVENT_NAME",new Error("INVALID_EVENT_NAME"),{name:i}])},c.prototype.getEvent=function(t){var e=this.memory.events.length;if(!(e<1))for(var i=e-1;i>=0;i--)if(this.memory.events[i].name==t)return this.memory.events[i]},c.prototype.getLastEvent=function(){var t=this.memory.events.length;return t>0?this.memory.events[t-1]:void 0},c.prototype.getTimestamp=function(){return Date.now()},c.prototype.getTimeDiff=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"seconds",r="seconds"==i?1e3:1;return Math.floor((t-e)/r)},p.prototype.reCSSExt=/(.css)/,p.prototype.supportedLocations=["bodyEnd","bodyStart","headEnd"],p.prototype.inject=function(t,e){var i=this;if(!e.id)throw new Error("Missing id for an injected script.");var r=i.reCSSExt.test(t),n=r?"link":"script";return new Promise((function(s,a){if(document.getElementById(e.id))return s(e.id);var o=setTimeout((function(){return a(new Error("TIMEOUT"))}),i.timeout),c=document.createElement(n);function p(){return r&&(c.media=e.media||"all"),clearTimeout(o),s(e.id)}c.id=e.id,"link"==n&&(c.rel="stylesheet",c.href=t,c.media="only x"),"script"==n&&(c.type=e.type||"text/javascript",c.async=!e.hasOwnProperty("async")||e.async),e.attrs&&Object.keys(e.attrs).map((function(t){return c.setAttribute(t,e.attrs[t])})),c.addEventListener?c.addEventListener("load",p,!1):c.readyState?c.onreadystatechange=p:c.onload&&(c.onload=p),c.onerror&&(c.onerror=function(t){return clearTimeout(o),a(t)}),"script"==n&&(c.src=t),i.injectToLocation(c,e.location)}))},p.prototype.injectJSONLD=function(t,e){if(e.id&&document.getElementById(e.id))return null;var i=document.createElement("script");i.type="application/ld+json",e.id&&(i.id=e.id),e.attrs&&Object.keys(e.attrs).map((function(t){return i.setAttribute(t,e.attrs[t])})),i.text="string"==typeof t?t:JSON.stringify(t),this.injectToLocation(i,e.location)},p.prototype.injectToLocation=function(t,e){var i=e||this.supportedLocations[0];if(-1!==this.supportedLocations.indexOf(i)){var r=document.getElementsByTagName("head")[0],n=document.getElementsByTagName("body")[0];"headEnd"==i?r.insertBefore(t,null):"bodyEnd"==i?n.insertBefore(t,null):"bodyStart"==i&&n.insertBefore(t,n.firstChild)}},p.prototype.remove=function(t){var e=document.getElementById(t);e&&e.parentNode.removeChild(e)};var u=new p;function m(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.id=t.id,this.userID=t.userID,this.initOpts={send_page_view:!1},this.userID&&(this.initOpts.user_id=this.userID),this.ready=!1,this.client=null,this.scriptTagID="lighthouse-service-google-analytics",this.scriptURL="https://www.googletagmanager.com/gtag/js?id="+this.id,this.reservedEventNames={screenView:"screen_view",time:"timing_complete",error:"exception",share:"share",search:"search",login:"login",signup:"sign_up"},this.parameterReference={screen_view:{params:["screen_name","app_name","app_id","app_version","app_installer_id"],match:{title:"screen_name",appName:"app_name",appID:"app_id",appVersion:"app_version",appInstallerID:"app_installer_id"},requiredParams:["screen_name","app_name"]},timing_complete:{params:["name","value","event_category","event_label"],match:{name:"event_category",category:"name",value:"value"},requiredParams:["name","value"]},exception:{params:["description","fatal"],match:{debug:"description"},requiredParams:["description"]},share:{params:["method","content_id","content_type"],match:{channel:"method",id:"content_id"},requiredParams:["method"]},search:{params:["term"],match:{term:"term"},requiredParams:["term"]}}}m.prototype.install=function(t){var e=this;return e.client=t,e.client.window.dataLayer=e.client.window.dataLayer||[],e.client.window.gtag=function(){dataLayer.push(arguments)},e.client.window.gtag("js",new Date),e.client.window.gtag("config",e.id,e.initOpts),new Promise((function(t,i){u.inject(e.scriptURL,{id:e.scriptTagID,location:"headEnd"}).then((function(){return e.ready=!0,t()})).catch((function(i){return e.client.emit("error",i),t()}))}))},m.prototype.event=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!0===this.ready){var i=this.findLocalEventName(t,e);if("screen_view"==i){var n=this.generatePageLoadParams(e);r.typekit.isObject(n)&&this.client.window.gtag("config",this.id,n)}var s=this.generateLocalParams(i,e);if(!r.typekit.isUndefined(s)){var a=this.parameterReference.hasOwnProperty(i);if(a){var o=this.parameterReference[i];if(o.hasOwnProperty("requiredParams")){var c=o.requiredParams.filter((function(t){return!0!==s.hasOwnProperty(t)}));if(c&&c.length>0)return void this.client.emit("error",[new Error("MISSING_PARAMS"),c.join(",")])}}this.client.window.gtag("event",i,s)}}},m.prototype.findLocalEventName=function(t,e){return"view"==t&&"screen"==r.objectkit.getProp(e,"category","")?this.reservedEventNames.screenView:this.reservedEventNames.hasOwnProperty(t)?this.reservedEventNames[t]:t},m.prototype.generateLocalParams=function(t,e){this.client.kit;var i=this.parameterReference.hasOwnProperty(t);if(i||e.hasOwnProperty("value")){if(!i&&e.hasOwnProperty("value"))return Object.assign({},{event_callback:function(){}},{event_label:e.value,event_category:"engagement"});var n=this.parameterReference[t],s=r.typekit.isObject(e.googleAnalytics)?e.googleAnalytics:{},a=Object.keys(n.match).reduce((function(t,i){return e.hasOwnProperty(i)&&(t[n.match[i]]=e[i]),t}),{});return Object.assign({},{event_callback:function(){}},a,s)}},m.prototype.generatePageLoadParams=function(t){this.client.kit;if(t.hasOwnProperty("path")&&r.validationkit.isNotEmpty(t.path)){var e={page_path:t.path,page_title:t.title};return r.validationkit.isNotEmpty(t.url)&&(e.page_location=t.url),e}},exports.LAGoogleAnalytics=m,exports.LighthouseAnalytics=c;
