import t from"event-emitter-object";import e from"local-storage-pro";import i from"visibility-state-listener";import{validationkit as r,typekit as n,objectkit as s}from"basekits";function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.call(this,{}),this.window=e.window||("undefined"==typeof window?void 0:window),this.document=e.document||("undefined"==typeof document?void 0:document),this.memory={events:[],referrer:null},this.isBusy=!1,this.storageKeys={id:"LA_ID",userTimestamp:"LA_USER_TIMESTAMP",sessionTimestamp:"LA_SESSION_TIMESTAMP"},this.sessionLifetime=1800,this.identify(),this.context={id:null,firstVisit:!1},this.visibilityState="visible",r.isNotEmpty(e.listenVisibilityChanges)&&this.listenVisibilityChanges(),this.timer=null,r.isNotEmpty(e.checkOnlineTime)&&this.startTimer(),this.queue=[],this.services=[]}function a(){this.timeout=1e4}o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.identify=function(){var t=e.getItem(this.storageKeys.id);if(t)this.updateContext({id:t});else{var i=((t=21)=>{let e="",i=t;for(;i--;)e+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[64*Math.random()|0];return e})();this.updateContext({id:i}),e.setItem(this.storageKeys.id,i)}var n=this.getTimestamp(),s=e.getItem(this.storageKeys.userTimestamp);r.isEmpty(s)&&(e.setItem(this.storageKeys.userTimestamp,n),this.updateContext({firstVisit:!0}));var o=e.getItem(this.storageKeys.sessionTimestamp);(r.isEmpty(o)||this.getTimeDiff(n,o)>this.sessionLifetime)&&e.setItem(this.storageKeys.sessionTimestamp,n),r.isNotEmpty(this.document)&&(this.memory.referrer=this.document.referrer)},o.prototype.listenVisibilityChanges=function(){var t=this,e=i({window:this.window,document:this.document});e.start(),e.emitter.on("update",(function(){var i=e.getState();i!=t.visibilityState&&(t.visibilityState=i,t.event("visibilityChange",{value:t.visibilityState}),t.emit("visibilityChange",t.visibilityState))}))},o.prototype.getVisibilityState=function(){return this.visibilityState},o.prototype.setContext=function(t){return n.isObject(t)&&(this.context=t),this},o.prototype.updateContext=function(t){return n.isObject(t)&&(this.context=Object.assign({},this.context,t)),this},o.prototype.install=function(){var t=this;return Promise.all(this.services.map((function(e){return e.install?e.install(t):Promise.resolve()})))},o.prototype.addService=function(t){return this.services.push(t),this},o.prototype.startTimer=function(){this.timer=setInterval(function(){this.emit("online"),this.event("online",{})}.bind(this),15e3)},o.prototype.clearTimer=function(){return r.isNotEmpty(this.timer)&&(clearInterval(this.timer),this.timer=null),this},o.prototype.isFirstVisit=function(){return this.context.firstVisit},o.prototype.event=function(t,e){return this.addToQueue({name:t,params:e}),this},o.prototype.addToQueue=function(t){return this.queue.push(t),this.processQueue(),!0},o.prototype.processQueue=function(){if(!0!==this.isBusy){this.isBusy=!0;var t=this.queue.shift();return this.processEvent(t.name,t.params),this.isBusy=!1,this.queue.length>0&&this.processQueue(),!0}},o.prototype.processEvent=function(t,e){var i=n.isString(t)&&n.isNotEmpty(t)?t:void 0,r=n.isObject(e)?Object.assign({},this.context,e):void 0;if(i){var o=this.getTimestamp(),a=s.getProp(this.getLastEvent(),"_timestamp",o),c=this.getTimeDiff(o,a),p=s.getProp(this.getEvent(i),"_timestamp",o),m=this.getTimeDiff(o,p),h={name:i,params:r,_timestamp:o,_timeDiffFromLastEvent:c,_timeDiffFromSameEvent:m};this.memory.events.push(h),0!==this.services.length?Promise.all(this.services.map(function(t){return t.event(i,r)}.bind(this))):this.emit("error",["NO_SERVICE_INSTALLED",new Error("NO_SERVICE_INSTALLED")])}else this.emit("error",["INVALID_EVENT_NAME",new Error("INVALID_EVENT_NAME"),{name:i}])},o.prototype.getEvent=function(t){var e=this.memory.events.length;if(!(e<1))for(var i=e-1;i>=0;i--)if(this.memory.events[i].name==t)return this.memory.events[i]},o.prototype.getLastEvent=function(){var t=this.memory.events.length;return t>0?this.memory.events[t-1]:void 0},o.prototype.getTimestamp=function(){return Date.now()},o.prototype.getTimeDiff=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"seconds",r="seconds"==i?1e3:1;return Math.floor((t-e)/r)},a.prototype.reCSSExt=/(.css)/,a.prototype.supportedLocations=["bodyEnd","bodyStart","headEnd"],a.prototype.inject=function(t,e){var i=this;if(!e.id)throw new Error("Missing id for an injected script.");var r=i.reCSSExt.test(t),n=r?"link":"script";return new Promise((function(s,o){if(document.getElementById(e.id))return s(e.id);var a=setTimeout((function(){return o(new Error("TIMEOUT"))}),i.timeout),c=document.createElement(n);function p(){return r&&(c.media=e.media||"all"),clearTimeout(a),s(e.id)}c.id=e.id,"link"==n&&(c.rel="stylesheet",c.href=t,c.media="only x"),"script"==n&&(c.type=e.type||"text/javascript",c.async=!e.hasOwnProperty("async")||e.async),e.attrs&&Object.keys(e.attrs).map((function(t){return c.setAttribute(t,e.attrs[t])})),c.addEventListener?c.addEventListener("load",p,!1):c.readyState?c.onreadystatechange=p:c.onload&&(c.onload=p),c.onerror&&(c.onerror=function(t){return clearTimeout(a),o(t)}),"script"==n&&(c.src=t),i.injectToLocation(c,e.location)}))},a.prototype.injectJSONLD=function(t,e){if(e.id&&document.getElementById(e.id))return null;var i=document.createElement("script");i.type="application/ld+json",e.id&&(i.id=e.id),e.attrs&&Object.keys(e.attrs).map((function(t){return i.setAttribute(t,e.attrs[t])})),i.text="string"==typeof t?t:JSON.stringify(t),this.injectToLocation(i,e.location)},a.prototype.injectToLocation=function(t,e){var i=e||this.supportedLocations[0];if(-1!==this.supportedLocations.indexOf(i)){var r=document.getElementsByTagName("head")[0],n=document.getElementsByTagName("body")[0];"headEnd"==i?r.insertBefore(t,null):"bodyEnd"==i?n.insertBefore(t,null):"bodyStart"==i&&n.insertBefore(t,n.firstChild)}},a.prototype.remove=function(t){var e=document.getElementById(t);e&&e.parentNode.removeChild(e)};var c=new a;function p(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.id=t.id,this.userID=t.userID,this.initOpts={send_page_view:!1},this.userID&&(this.initOpts.user_id=this.userID),this.ready=!1,this.client=null,this.scriptTagID="lighthouse-service-google-analytics",this.scriptURL="https://www.googletagmanager.com/gtag/js?id="+this.id,this.reservedEventNames={screenView:"screen_view",time:"timing_complete",error:"exception",share:"share",search:"search",login:"login",signup:"sign_up"},this.parameterReference={screen_view:{params:["screen_name","app_name","app_id","app_version","app_installer_id"],match:{title:"screen_name",appName:"app_name",appID:"app_id",appVersion:"app_version",appInstallerID:"app_installer_id"},requiredParams:["screen_name","app_name"]},timing_complete:{params:["name","value","event_category","event_label"],match:{name:"event_category",category:"name",value:"value"},requiredParams:["name","value"]},exception:{params:["description","fatal"],match:{debug:"description"},requiredParams:["description"]},share:{params:["method","content_id","content_type"],match:{channel:"method",id:"content_id"},requiredParams:["method"]},search:{params:["term"],match:{term:"term"},requiredParams:["term"]}}}p.prototype.install=function(t){var e=this;return e.client=t,e.client.window.dataLayer=e.client.window.dataLayer||[],e.client.window.gtag=function(){dataLayer.push(arguments)},e.client.window.gtag("js",new Date),e.client.window.gtag("config",e.id,e.initOpts),new Promise((function(t,i){c.inject(e.scriptURL,{id:e.scriptTagID,location:"headEnd"}).then((function(){return e.ready=!0,t()})).catch((function(i){return e.client.emit("error",i),t()}))}))},p.prototype.event=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!0===this.ready){var i=this.findLocalEventName(t,e);if("screen_view"==i){var r=this.generatePageLoadParams(e);n.isObject(r)&&this.client.window.gtag("config",this.id,r)}var s=this.generateLocalParams(i,e);if(!n.isUndefined(s)){var o=this.parameterReference.hasOwnProperty(i);if(o){var a=this.parameterReference[i];if(a.hasOwnProperty("requiredParams")){var c=a.requiredParams.filter((function(t){return!0!==s.hasOwnProperty(t)}));if(c&&c.length>0)return void this.client.emit("error",[new Error("MISSING_PARAMS"),c.join(",")])}}this.client.window.gtag("event",i,s)}}},p.prototype.findLocalEventName=function(t,e){return"view"==t&&"screen"==s.getProp(e,"category","")?this.reservedEventNames.screenView:this.reservedEventNames.hasOwnProperty(t)?this.reservedEventNames[t]:t},p.prototype.generateLocalParams=function(t,e){this.client.kit;var i=this.parameterReference.hasOwnProperty(t);if(i||e.hasOwnProperty("value")){if(!i&&e.hasOwnProperty("value"))return Object.assign({},{event_callback:function(){}},{event_label:e.value,event_category:"engagement"});var r=this.parameterReference[t],s=n.isObject(e.googleAnalytics)?e.googleAnalytics:{},o=Object.keys(r.match).reduce((function(t,i){return e.hasOwnProperty(i)&&(t[r.match[i]]=e[i]),t}),{});return Object.assign({},{event_callback:function(){}},o,s)}},p.prototype.generatePageLoadParams=function(t){this.client.kit;if(t.hasOwnProperty("path")&&r.isNotEmpty(t.path)){var e={page_path:t.path,page_title:t.title};return r.isNotEmpty(t.url)&&(e.page_location=t.url),e}};export{p as LAGoogleAnalytics,o as LighthouseAnalytics};
